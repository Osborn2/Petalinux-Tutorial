# Command lines for using Petalinux 
-- Petalinux with differnet version has differernt functions. The commands we used are tested under Petaliux v.15.4. For the new commands in the latest Petalinux, please refer to the lastest user guide (ug1157)

##### Commands for generating Linux kernel compatible with SDSoC under ZC706 platform

1. Download and install Petalinux v.15.4 (ug976)
    * Currently the latest Petalinux may has some bugs.
2. Setup linux environment 
    $ source <path to directory of Petalinux>/settings.sh  or
    $ source <path to directory of Petalinux>/settings.csh 
    
    You can see these lines in the terminal
    PetaLinux environment set to '<path to directory of Petalinux>'
    INFO: Checking free disk space
    INFO: Checking installed tools
    INFO: Checking installed development libraries
    INFO: Checking network and other services
    
    * If there are some errors and warnings, please refer to ug976: Troubeshotting section
    
3. Create a new petalinxux project
    3.1 Configuring hardware platform within .hdf file generated by within Xilinx SDK (More details: ug1144)
    * For generating hardware platform withini SDK, please refer to the following link:
        https://www.xilinx.com/support/documentation/sw_manuals/xilinx14_5/SDK_Doc/tasks/sdk_t_hwspec.htm
    $ petalinux-create --type project --template zynq --name <project name>
    $ petalinux-config --get-hw-description=<directory of .hdf file>

    3.2 Configuring hardware platform within Board Support Package (BSP)
    * Downloading the BSP you need from following link:
        https://www.xilinx.com/support/download/index.html/content/xilinx/en/downloadNav/embedded-design-tools.html
    $ petalinux-create -t project -s <directory of BSP>/Xilinx-ZC706-v2015.4-final.bsp --name <project name>

*** Details about configuration will be coverd in the Linux configuration directory
4. Linux configuration
    4.1 General configration
        $ cd <directory of petalinux project>
        $ petalinux-config
        
        (1) Subsystem AUTO Hardware Settings → Ethernet Settings → Ethernet MAC address → <MAC address of your board>
        (2) Image Packing Configuration → Root filesystem type → SD card (For permanent storage)
        (3) Auto Config Settings ---> [ ] kernel autoconfig ***Disable the kernel auto configure setting***
        
    4.2 Root file system configration
        $ cd <directory of petalinux project>
        $ petalinux-config -c rootfs
 
        (1) Filesystem Packages → console/network → dropbear → enable dropbear-openssh-sftp-server
        (2) Filesystem Packages → console/network → openssh → enable openssh-sftp-server
        * enable ssh remote login
        (3) Filesystem Packages → base → openssh → external-xilinx-toolchain → enable libstdc++6
        (4) Filesystem Packages → base → openssh → external-xilinx-toolchain → enable tcf-agent
        * enable libray and function for SDSoC
        
    4.3 Kernel configuration
        $ cd <directory of petalinux project>
        $ petalinux-config -c kernel
        
        (1) kernel features → enable contiguous memory allocator
        (2) device drivers → generic driver options → enable DMA contiguous memory allocator 
        (3) device drivers → generic driver options → size in mega bytes [256]
        (4) device drivers → enable staging drivers; Xilinx APF accelerator driver; Xilinx APF DMA engines support
        (5) general setup → enable Initial RAM filesystem and RAM disk (initramfs/initrd) support
        
    4.4 Extra configuration
       $ vi <directory of project>/subsystems/linux/configs/device-tree/system-top.dts
       append following code:
            &clkc {
               fclk-enable = <0xf>;
            };
            / {
               xlnk {
               compatible = "xlnx,xlnk-1.0";
               clock-names = "xclk0", "xclk1", "xclk2", "xclk3";
               clocks = <&clkc 15>, <&clkc 16>, <&clkc 17>, <&clkc 18>;
               };
             };   

5. Build the Linux system
      $ petalinux-build
      * Note: this step may take time
     
6. For packaging your Linux kernel, SDSoC is required. So please source SDSoC like this:
      source <directory of SDSoC>/SDSoC/2015.4/license.sh
      source <directory of SDSoC>/SDSoC/2015.4/settings64.sh

7. Generating Boot loader
      $ cd <directory of project>/images/linux
      $ petalinux-package --boot --format BIN --fsbl zynq_fsbl.elf --u-boot --force

8. Generating rootfs.cpio image if required***
      $ petalinux-package --image -c rootfs --format initramfs
     
9. Prepare SD card (details in ug1144: Configuring SD Card ext filesystem Boot)
      Partition the SD card with two parts:
         (1) 32FAT filesystem; 100M; 4MB free space; label BOOT
         (2) ext4 filesystem; the remaining space; label rootfs
         
10. Copy files into SD card
      $ cp <directory of project>/images/linux/BOOT.bin <directory of SD card>/BOOT/
      $ cp <directory of project>/images/linux/image.ub <directory of SD card>/BOOT/
      $ cp <directory of project>/images/linux/rootfs.cpio <directory of SD card>/rootfs/
      
11. Extract the file system
      $ cd <directory of SD card>/rootfs/
      $ sudo pax -rvf rootfs.cpio
      *** After doing that, you can see the whole root file system including /bin /etc /sbin ... in the directory rootfs

12. Boot the system with SD card
      (1) Set boot mode to SD - DIP switch SW11 positions 3 and 4 set to 1
      (2) Connect the serial port on the board (UART)
            e.g. Tera Term with Baud rate 115200 (details in ug963: setting up board communications)
